# eckWMS Port Standard

## Обзор

Проект eckwmsgo использует диапазон портов **3210-3219** для всех сервисов. Это позволяет избежать конфликтов с Node.js проектами (которые обычно используют 3000-3009) и предоставляет резерв для будущего масштабирования по модели Odoo.

## Стандарт портов

### Основные порты (в использовании)

| Порт | Сервис | Статус | Описание |
|------|--------|--------|----------|
| **3210** | Main API + Frontend | ✅ **Активен** | Основной монолитный сервер (Go + embedded SvelteKit) |
| 3211 | Auth Service | 🔒 Зарезервирован | Будущий микросервис аутентификации |
| 3212 | Warehouse Service | 🔒 Зарезервирован | Будущий микросервис складских операций |
| 3213 | Sync Service | 🔒 Зарезервирован | Будущий микросервис синхронизации с Odoo |
| 3214 | Delivery Service | 🔒 Зарезервирован | Будущий микросервис доставки (OPAL, DHL, и т.д.) |
| 3215 | Analytics Service | 🔒 Зарезервирован | Будущий микросервис аналитики и отчетов |
| 3216 | AI Service | 🔒 Зарезервирован | Будущий микросервис AI агентов |
| 3217 | Print Service | 🔒 Зарезервирован | Будущий микросервис печати этикеток |
| 3218 | Barcode Service | 🔒 Зарезервирован | Будущий микросервис Smart Codes |
| 3219 | Integration Service | 🔒 Зарезервирован | Будущий микросервис внешних интеграций |

### Вспомогательные порты

| Порт | Сервис | Описание |
|------|--------|----------|
| 5173 | Vite Dev Server | SvelteKit frontend в dev режиме (npm run dev) |
| 5432 | PostgreSQL | База данных (embedded или external) |

## Текущая архитектура (Монолит)

```
┌─────────────────────────────────────────┐
│     eckwms.exe (Один процесс)           │
│  Порт 3210 (настраивается через PORT)   │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────────────────────────┐  │
│  │   HTTP Router (Gorilla Mux)       │  │
│  │   - REST API (/api/*)             │  │
│  │   - Auth endpoints (/auth/*)      │  │
│  │   - WebSocket (/ws)               │  │
│  │   - Static files (embedded        │  │
│  │     SvelteKit frontend)           │  │
│  └───────────────────────────────────┘  │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │   Odoo Sync Service               │  │
│  │   (фоновая горутина)              │  │
│  └───────────────────────────────────┘  │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │   Delivery Service                │  │
│  │   (OPAL, DHL и др.)               │  │
│  └───────────────────────────────────┘  │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │   WebSocket Hub                   │  │
│  │   (для сканеров/устройств)        │  │
│  └───────────────────────────────────┘  │
│                                         │
└─────────────────────────────────────────┘
```

## Будущая архитектура (Микросервисы)

Когда проект вырастет, мы сможем разделить монолит на микросервисы:

```
┌───────────────────────────────────────────────┐
│         API Gateway / Frontend (3210)         │
└───────────────────┬───────────────────────────┘
                    │
    ┌───────────────┼───────────────┐
    │               │               │
    ▼               ▼               ▼
┌──────┐      ┌──────────┐    ┌──────────┐
│ Auth │      │Warehouse │    │ Delivery │
│(3211)│      │  (3212)  │    │  (3214)  │
└──────┘      └──────────┘    └──────────┘
    │               │               │
    └───────────────┼───────────────┘
                    ▼
            ┌──────────────┐
            │ PostgreSQL   │
            │   (5432)     │
            └──────────────┘
```

## Конфигурация

### .env файл

```env
# Основной порт (монолит или API Gateway)
PORT=3210

# Если в будущем добавятся микросервисы:
# AUTH_SERVICE_PORT=3211
# WAREHOUSE_SERVICE_PORT=3212
# SYNC_SERVICE_PORT=3213
# DELIVERY_SERVICE_PORT=3214
```

### Nginx конфигурация (для продакшена)

```nginx
# Монолитная конфигурация (текущая)
location /E/ {
    proxy_pass http://localhost:3210/E/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}
```

```nginx
# Микросервисная конфигурация (будущая)
location /E/ {
    proxy_pass http://localhost:3210/E/;  # Frontend + Gateway
}

location /E/api/auth/ {
    proxy_pass http://localhost:3211/;  # Auth Service
}

location /E/api/warehouse/ {
    proxy_pass http://localhost:3212/;  # Warehouse Service
}

location /E/api/delivery/ {
    proxy_pass http://localhost:3214/;  # Delivery Service
}
```

## Принципы выбора портов

1. **Последовательность**: Порты идут подряд от 3210 до 3219
2. **Логическая группировка**: Похожие сервисы рядом (Auth 3211, Warehouse 3212, Sync 3213)
3. **Избегание конфликтов**:
   - 3000-3009 зарезервированы для Node.js/npm
   - 3210-3219 уникальны для eckWMS
4. **Масштабируемость**: Достаточно портов для 10 микросервисов
5. **Odoo-подход**: Как в Odoo, где разные модули могут работать на разных портах

## Примеры использования

### Монолит (текущая версия)

```bash
# Запуск всего приложения на одном порту
PORT=3210 ./eckwms

# Доступ ко всему через :3210
curl http://localhost:3210/health
curl http://localhost:3210/api/odoo/pickings
curl http://localhost:3210/api/delivery/shipments
```

### Микросервисы (будущая версия)

```bash
# Запуск каждого сервиса отдельно
PORT=3210 ./eckwms-gateway
PORT=3211 ./eckwms-auth
PORT=3212 ./eckwms-warehouse
PORT=3214 ./eckwms-delivery

# Каждый сервис доступен на своем порту
curl http://localhost:3211/login     # Auth
curl http://localhost:3212/stocks    # Warehouse
curl http://localhost:3214/shipments # Delivery
```

## Dev режим

В dev режиме SvelteKit работает на отдельном порту и проксирует API запросы:

```
┌─────────────────┐          ┌──────────────────┐
│  Browser        │          │  Go Backend      │
│  :5173          │ ────────▶│  :3210           │
│  (Vite)         │  Proxy   │  (API Server)    │
└─────────────────┘  API     └──────────────────┘
                     requests
```

```bash
# Terminal 1: Go Backend
go run ./cmd/api/main.go
# Слушает на :3210

# Terminal 2: Frontend Dev Server
cd web && npm run dev
# Слушает на :5173, проксирует /api/* на :3210
```

## Migration Path (Монолит → Микросервисы)

Когда придет время разделить монолит:

1. **Phase 1**: Выделить Auth Service (3211)
   - Вынести /auth/* endpoints в отдельный сервис
   - Gateway (3210) проксирует запросы на 3211

2. **Phase 2**: Выделить Warehouse Service (3212)
   - Вынести /api/warehouse/* endpoints
   - Общая база данных или separate DB

3. **Phase 3**: Выделить другие сервисы по необходимости
   - Delivery (3214), Analytics (3215), и т.д.

## Проверка занятости порта

```bash
# Windows
netstat -ano | findstr :3210

# Linux/Mac
lsof -i :3210

# Если порт занят, измените PORT в .env
PORT=3211 ./eckwms
```

## FAQ

### Почему не 3000?
- 3000 часто используется Node.js проектами (Create React App, Next.js, и т.д.)
- 3001-3009 тоже могут быть заняты другими dev серверами

### Почему не 8080?
- 8080 часто используется для production серверов
- Мы резервируем 8080 для будущего GLOBAL_SERVER_PORT

### Можно ли изменить порт?
- Да! Просто установите `PORT=XXXX` в `.env`
- Стандарт 3210 - это рекомендация, не требование

### Что если нужно больше 10 микросервисов?
- Используйте диапазон 3220-3229 для дополнительных сервисов
- Или используйте динамическое выделение портов (ephemeral ports)

## Связанные документы

- `QUICKSTART.md` - Быстрый старт с портом 3210
- `README.md` - Общая документация
- `DEPLOYMENT_SUBDIRECTORY.md` - Деплой с Nginx
- `.eck/SERVER_ACCESS.md` - Production конфигурация
